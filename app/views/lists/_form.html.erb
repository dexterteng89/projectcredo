<div id="list-edit">

  <% url = if list.persisted? then user_list_path(list.owner, list) else lists_path end  %>

  <%= form_for(list, url: url) do |f| %>
    <% if list.errors.any? %>
      <div id="error_explanation">
        <h2><%= pluralize(list.errors.count, "error") %> prohibited this list from being saved:</h2>

        <ul>
          <% list.errors.full_messages.each do |message| %>
            <li><%= message %></li>
        <% end %>
        </ul>
      </div>
    <% end %>
    <div class="form-horizontal">
      <div class="form-group">
        <%= f.label :name, class: "col-md-2 control-label" %>
        <div class="col-md-10">
          <%= f.text_field :name, class: "form-control" %>
        </div>
      </div>

      <div class="form-group">
        <%= f.label :description, class: "col-md-2 control-label" %>
        <div class="col-md-10">
          <%= f.text_area :description, class: "form-control", rows: 5 %>
        </div>
      </div>

      <div class="form-group">
        <div class="col-md-2 control-label">
          <%= f.label :tag_list, 'Tags'%>
          <p><small>(separated by commas)</small></p>
        </div>
        <div class="col-md-10">
          <%= f.text_field :tag_list, value: list.tag_list.join(","), class: "form-control", placeholder: 'Ex: biology, chemistry, physics' %>
        </div>
      </div>

      <div class="form-group">
        <div class="col-md-2 control-label">
          <%= f.label :participants, 'List participants'%>
          <p><small>(who can add to this list?)</small></p>
        </div>
        <div class="col-md-10">
          <%= f.select :participants,
            options_for_select(
              [%w{Public public},%w{Contributors contributors}],
              list.participants
            ),
            {},
            {class: "form-control", disabled: list.persisted? && !(current_user == list.owner)} %>
        </div>
      </div>

      <% if list.persisted? %>
        <div class="form-group">
          <label class="col-md-2 control-label">List owner</label>
          <div class="col-md-10">
            <div class="form-control contributor-list">
              <%= link_to list.owner.username, user_lists_path(list.owner) %>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="col-md-2 control-label">Current contributors</label>
          <div class="col-md-3">
            <% members = list.members.where.not(id: list.owner.id) %>
              <div
                class="form-control contributor-list"
                v-for="member in members"
              >
                <a href="/">{{ member }}</a>
                <button
                  class="btn btn-xs btn-default pull-right"
                  type="button"
                  v-if="currentUserCanModerate"
                  v-on:click="removeMember(member)"
                >X</button>
              </div>
          </div>
        </div>
      <% end %>

      <div class="form-group">
        <%= f.label :members, 'Add a contributor', class: "col-md-2 control-label"  %>
        <input name="list[members]" id="list_members" v-bind:value="members"></input>
        <div class="col-md-10">
          <select
            class="form-control"
            v-bind:disabled="selectDisabled"
            v-model="selected"
            v-on:click="addMember()"
          >
            <option value=""><i>Users</i></option>
            <option
              v-for="nonMember in nonMembers"
              v-bind:value="nonMember"
              v-text="nonMember"
            >
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
          <%= f.submit button_name, class: "btn btn-primary" %>
          <%= link_to 'cancel',
            if list.id then user_list_path(list.user, list) else root_path end
          %>
        </div>
      </div>
    </div>
  <% end %>

</div>

<% content_for(:page_app) do %>
  <script>
    var editList = new Vue({
      el: '#list-edit',
      data: {
        selected: '',
        owner: '<%= list.owner.username %>',
        selectDisabled:
          <%= if list.persisted? then !current_user.can_moderate?(list) else false end %>,
        nonMembers: <%= raw (User.all.map(&:username) - @list.members.map(&:username) - [@list.owner.username]) %>,
        members: <%= raw @list.members.map(&:username) %>,
        currentUserCanModerate: <%= current_user_can_moderate?(list) || list.members.include?(current_user) %>
      },
      methods: {
        addMember() {
          if(this.selected != '') {
            this.members.push(this.selected);
            var index = this.nonMembers.indexOf(this.selected);
            this.nonMembers.splice(index,1);
            this.selected = ''
          }
        },
        removeMember(member) {
          this.nonMembers.push(member);
          var index = this.members.indexOf(member);
          this.members.splice(index,1);
        }
      }
    })
  </script>
<% end %>
